L.mapbox.accessToken="pk.eyJ1IjoiZmVucmlzIiwiYSI6InRHbm4xbkEifQ.Q_qWH1M_NebCj3c6yiyXng";var h2o={};h2o.CALLBACK_URL="https://spreadsheets.google.com/feeds/cells/1SgQvKoejjnWaQhcwTP39EDYUOmPCTK9Pc8li9cuOLu8/od6/public/values?alt=json-in-script&callback=myCallback",h2o.SHEET="https://docs.google.com/spreadsheets/d/1SgQvKoejjnWaQhcwTP39EDYUOmPCTK9Pc8li9cuOLu8/edit?usp=sharing",h2o.DIMS={HEIGHT:300,WIDTH:350},h2o.parseDate=d3.time.format("%m/%d/%Y"),h2o.weekOffset=-6048e5,h2o.weekAgo=new Date((new Date).getTime()+h2o.weekOffset),h2o.latest=h2o.weekAgo,h2o.ndx=crossfilter(),h2o.all=h2o.ndx.groupAll(),h2o.allDim=h2o.ndx.dimension(function(e){return e}),h2o.dateDim=h2o.ndx.dimension(function(e){return e.Date}),h2o.dateCount=h2o.dateDim.group().reduceCount(),h2o.dateChart=dc.barChart("#chart-event-date"),h2o.regionDim=h2o.ndx.dimension(function(e){return e.Region}),h2o.regionCount=h2o.regionDim.group().reduceCount(),h2o.regionChart=dc.rowChart("#chart-region-row"),h2o.monthDim=h2o.ndx.dimension(function(e){return e.Month}),h2o.monthCount=h2o.monthDim.group().reduceCount(),h2o.monthChart=dc.rowChart("#chart-month-row"),h2o.eventTypeDim=h2o.ndx.dimension(function(e){return e["Event Type"]}),h2o.eventTypeCount=h2o.eventTypeDim.group().reduceCount(),h2o.eventTypeChart=dc.rowChart("#chart-event-type-row"),h2o.table=dc.dataTable("#event-list");var header;h2o.data=[],h2o.dataDiv=d3.select("#data"),h2o.statusMsgDiv=d3.select("#status-msg"),h2o.statusMsgDiv.text("loading data..."),h2o.statusContainerDiv=d3.select("#status-container"),d3.selectAll("a#all").on("click",function(){dc.filterAll(),dc.renderAll()}),d3.selectAll("a#event-date").on("click",function(){h2o.dateChart.filterAll(),dc.redrawAll()}),d3.selectAll("a#region").on("click",function(){h2o.regionChart.filterAll(),dc.redrawAll()}),d3.selectAll("a#month").on("click",function(){h2o.monthChart.filterAll(),dc.redrawAll()}),d3.selectAll("a#event-type").on("click",function(){h2o.eventTypeChart.filterAll(),dc.redrawAll()}),h2o.init=function(){Tabletop.init({key:h2o.SHEET,callback:h2o.test})},h2o.test=function(e,t){h2o.statusMsgDiv.text("Spreadsheet loaded....processing..."),h2o.data=e,h2o.tabletop=t,h2o.overview_columns=e.Overview.columnNames,h2o.overview=[],h2o.old=[];var o=["Latitude","Longitude"];e.Overview.elements.forEach(function(e){o.forEach(function(t){e[t]=+e[t]}),e.Date=h2o.parseDate.parse(e.Date),""==e["Event Type"]&&(e["Event Type"]="Unknown"),e.Date>h2o.weekAgo?h2o.overview.push(e):h2o.old.push(e),e.Date>h2o.latest&&(h2o.latest=e.Date)}),h2o.ndx.add(h2o.overview),h2o.statusMsgDiv.text("Building charts..."),h2o.buildCharts()},h2o.buildCharts=function(){h2o.dateChart.width(2*h2o.DIMS.WIDTH).height(h2o.DIMS.HEIGHT/2).dimension(h2o.dateDim).group(h2o.dateCount).x(d3.time.scale().domain([h2o.weekAgo,h2o.latest])).round(d3.time.week.round).alwaysUseRounding(!0).xUnits(d3.time.weeks).gap(1).centerBar(!0),h2o.regionChart.width(h2o.DIMS.WIDTH).height(h2o.DIMS.HEIGHT).dimension(h2o.regionDim).group(h2o.regionCount).elasticX(!0),h2o.monthChart.width(h2o.DIMS.WIDTH).height(h2o.DIMS.HEIGHT).dimension(h2o.monthDim).group(h2o.monthCount).elasticX(!0),h2o.eventTypeChart.width(h2o.DIMS.WIDTH).height(h2o.DIMS.HEIGHT).dimension(h2o.eventTypeDim).group(h2o.eventTypeCount).elasticX(!0),h2o.table.dimension(h2o.allDim).group(function(e){return"Event table"}).columns([{label:"Festival or Race",format:function(e){return'<a href="'+e["Festival or Race Page URL"]+'">'+e["Festival or Race"]+"</a>"}},{label:"Date",format:function(e){return e.Date.toDateString()}},"Region",{label:"Section",format:function(e){return""==e["River(s)"]?"<small>"+e["Section(s) (Grade)"]+"</small>":""!=e["Section(s) (Grade)"]?"<small>"+e["River(s)"]+" - "+e["Section(s) (Grade)"]+"</small>":"<small>"+e["River(s)"]+"</small>"}}]).sortBy(function(e){return e.Date}).order(d3.ascending).on("renderlet",function(e){e.select("tr.dc-table-group").remove()}),dc.renderAll(),h2o.statusContainerDiv.style("display","none"),h2o.dataDiv.transition().style("opacity","1")},window.addEventListener("DOMContentLoaded",h2o.init);